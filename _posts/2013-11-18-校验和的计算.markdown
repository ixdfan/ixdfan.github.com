---
author: UCSHELL
comments: true
date: 2013-11-18 08:37:52+00:00
layout: post
title: 校验和的计算
wordpress_id: 1027
categories:
- 网络编程
tags:
- 校验和
---

TCP/UDP校验和与伪首部

今天在写扫描器的时候才知道原来TCP/UDP的校验和中还要包括伪首部，以前压根都不知道还要写伪首部！垃圾书籍害死人啊！

TCP/UDP校验和锁需要的数据包括以下三部分：

1. 伪首部
2. 首部
3. 数据部分

** 伪首部并非TCP\UDP数据报中实际的有效成分。伪首部不会发送，仅仅用于计算校验和。**

伪首部是一个虚拟的数据结构，其中的信息是从数据报所在IP分组头的分组头中提取的，既不向下传送也不向上递交，而仅仅是为计算校验和。这样的校验和，既校验了TCP\UDP用户数据的源端口号和目的端口号以及TCP\UDP用户数据报的数据部分，又检验了IP数据报的源IP地址和目的地址。伪报头保证TCP\UDP数据单元到达正确的目的地址。因此，伪报头中包含IP地址并且作为计算校验和需要考虑的一部分。最终目的端根据伪报头和数据单元计算校验和以验证通信数据在传输过程中没有改变而且到达了正确的目的地址。

##### 伪首部的作用:
用于检验P数据报已经到达正确的目的地，即正确的主机和协议端口。

尽管IP数据报首部已经包含了必要的校验和，但是，它并不能保证检验出所有的首部错误，因此，为了确保数据传输的正确性，在报文验证时，通过增加伪首部信息校验，再次对IP数据报中的源IP地址、目的IP地址、协议类型和数据长度等信息进行校验。

需要注意的是，**伪首部的内容在报文的传输中是不需要传送的**，即报文中并不安排专门的位置存放伪首部内容，只是在发送报文时计算校验和，以及接收报文时验证校验和时，需要将伪首部定义的内容纳入校验和计算和验证的范畴。

校验和的计算：
1. 把伪首部添加到TCP/UDP上
2. 计算初始时将校验和设置为0 //非常重要，否则校验和的结果将是错误的
3. 将所有位划分为16位的字(一个字是两个字节)
4. 将所有16为的字相加，如果遇到进位，将高于16字节的进位部分的值加到最低位上。
		0xBB5E+0xFCED=0x1 B84B，则将1加到最低位，得到结果是0xB84C
5. 将所有字相加的结果取反就是校验和的值
    
    unsigned short checkSum(void * buffer, int size)
    {
            unsigned long cksum=0;
    
            while (size > 1) {
    		cksum += *(unsigned short *)buffer;
    		size -= sizeof(unsigned short);
    		buffer = (char *)buffer + sizeof(unsigned short);
            }
    
            if (size)
                    cksum += *(unsigned char*)buffer;
    
            while(cksum >> 16)
                    cksum = (cksum >> 16) + (cksum & 0xffff);
    	/*
    	while也可以换成一下代码：
    	cksum = (cksum >> 16) + (cksum & 0xffff);	//将高16bit与低16bit相加
    	cksum += (cksum >> 16);				//将进位到高位的16bit与低16bit 再相加
    	*/
            return (unsigned short) (~cksum);
    }



##### 注意：

###### * TCP/UDP的校验和包含伪首部、首部、数据部分，但是发送时并不发送伪首部。

###### * IP头的首部检验和仅仅计算数据报的首部，但是不包含数据部分。

这是因为数据报每经过一个路由器，路由器都要重新计算一下首部校验和(一些字段，如生存时间、标志、片位移都可能变化)，不检验数据部分可以减少计算工作，进一步减少计算校验和的工作量。



![TCP伪首部](/uploads/2013/TCP.png)


![UDP伪首部](/uploads/2013/UDP.png)

伪首部的格式是相同的：源IP地址、目的IP地址、8位的全0、8位的协议值(TCP为6或IPPROTO_TCP，UDP为17或IPPROTO_UDP)、协议报文总长度(**包含数据部分**)
