<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>线程(一):基础 &#8211; 高手之路</title>
<meta name="description" content="">
<meta name="keywords" content="线程">


<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="线程(一):基础">
<meta property="og:description" content="专注于linux下程序设计">
<meta property="og:url" content="http://ucshell.github.com/2013/11/08/pthread-base/">
<meta property="og:site_name" content="高手之路">





<link rel="canonical" href="http://ucshell.github.com/2013/11/08/pthread-base/">
<link href="http://ucshell.github.com/feed.xml" type="application/atom+xml" rel="alternate" title="高手之路 Feed">
<link rel="author" href="https://plus.google.com/ucshell.neo@gmail.com?rel=author">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="http://ucshell.github.com/assets/css/main.min.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://ucshell.github.com/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://ucshell.github.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://ucshell.github.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://ucshell.github.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://ucshell.github.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://ucshell.github.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://ucshell.github.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://ucshell.github.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://ucshell.github.com/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://ucshell.github.com">高手之路</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				<li><a href="http://ucshell.github.com" >Home</a></li>
		        
				<li><a href="http://ucshell.github.com/posts/" >Posts</a></li>
		        
				<li><a href="http://ucshell.github.com/about/" >About</a></li>
		        
				<li><a href="http://ucshell.github.com/comment/" >Leave a message</a></li>
		        
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    <img src="http://ucshell.github.com/images/Neo.jpg" class="bio-photo" alt="Neo bio photo"></a>
<h3>Neo</h3>
<p>每一个优秀的人,都会有一段沉默的时光. 那一段时光,是付出了很多努力,忍受孤独和寂寞,不抱怨不诉苦. 日后说起时,连自己都能被感动的日子.</p>


<a href="https://plus.google.com/ucshell.neo@gmail.com" class="author-social" target="_blank"><i class="icon-google-plus"></i> Google+</a>










  </div>
  <article>
    <div class="headline-wrap">
      <h1>线程(一):基础</h1>
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <h1></h1>

<p>线程的概念：
一个进程中每一个线程都有自己的运行环境上下文，包括线程ID、一组寄存器的值、堆、栈、信号屏蔽字等。</p>

<p><strong>进程间所有的资源都被线程所共享，包括可执行的程序代码、全局变量、堆、栈、文件描述符。</strong></p>

<p>** 线程之间的堆栈式独立的！**</p>

<h5>注意：</h5>

<ul>
<li>由于引入了线程的概念，所以操作系统中的执行实体不在是进程，而是线程。</li>
<li>进程是系统资源分配的最小单位，线程是系统进程调度的单位。</li>
</ul>

<p>Linux中的线程是一个轻量级的进程</p>

<h1></h1>

<h5>线程的优势：</h5>

<ol>
<li>线程共享进程地址空间内的所有资源，所以线程之间的通信时非常方便的。
同样的任务如果使用多进程编程模型，就必须使用操作系统提供的进程间通信方式。其效率和程序设计的复杂度都会受很大的影响。执行多个任务的线程协调起来非常的方便，提高了效率也降低了编程的复杂度。</li>
<li>多个线程处理不同的任务，增加了程序的并发性，使程序高效的执行。
例如：外排序的实例中，呆排序的数据过于庞大，无法一次读取到内存中操作时，则需要先将数据读入内存，进行排序后输出到磁盘，这样程序的绝大部分时间都是浪费在输入输出(I/O操作)上,使得CPU处于空闲状态。如果使用多线程编程模型可以改善这个问题，可以创建三个进程，一个线程从磁盘读入数据，一个线程负责将数据排序，一个线程负责将排好序的数据输出。
在交互式程序中创建一个单独的线程接受用户输入的命令，并创建另一个线程来对这些命令进行处理。
浏览器就是采用这种方式，一个线程处理用户输入(鼠标或键盘)，一个线程负责显示请求站点发回的数据，剩下的线程分别就收不同的数据包。</li>
</ol>

<h1></h1>

<p>线程标识符的类型为pthread_t</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">pthread_t pthread_self(void);
</code></pre></div>
<p>使用pthread_self来查看线程ID</p>

<h5>注意：</h5>

<p><strong>pthread_t的类型为unsigned long int，所以在打印的时候要使用%lu方式，否则将产生奇怪的结果。</strong></p>

<p>比较两个线程ID是否相等</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">int pthread_equal(pthread_t t1, pthread_t t2);
</code></pre></div>
<p>如果相等则返回0，不相等则返回非0值</p>

<p>实例：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">    pthread_t pid;
    tid = pthread_self;
    if(0 == pthread_equal(save_tid, tid))
        ……
    else
        ……
</code></pre></div>
<h1></h1>

<p>线程的创建：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">int pthread_create(pthread_t *thread, const pthread_attr_t *attr,void *(*start_routine) (void *), void *arg);
</code></pre></div>
<h5>注意:</h5>

<p>start_routine函数的类型必须是void* ()(void*)类型的函数</p>

<h5>注意：</h5>

<p><strong>如果pthread_create函数(所有线程系列函数)创建成功则返回0，但是如果线程失败，返回的是错误编号，而不是像Linux其他函数一样返回-1并设置errno。
这种规律适合于线程中所有函数。</strong></p>

<h1></h1>

<p>实例：</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">void* thfun(void* arg)
{
        pid_t pid;
        pthread_t tid;

        pid = getpid();
        tid = pthread_self();
        printf(&quot;the new pthread pid is : %u,tid is %u\n&quot;,
                (unsigned int)pid, (unsigned int)tid);
        return NULL;
}
int main()
{
        pid_t pid;
        int err;
        pthread_t tid, mtid;

        pid = getpid();
        mtid = pthread_self();
        err = pthread_create(&amp;tid, NULL, thfun, NULL);

        if(err){
                printf(&quot;can&#39;t create thread %s\n&quot;, strerror(err));
                exit(1);
        }
        sleep(1);
        printf(&quot;the main pthread : pid id :%u, tid is %u\n&quot;,
                        (unsigned int)pid, (unsigned int)mtid);
        return 0;
}
</code></pre></div>
<h1></h1>
<div class="highlight"><pre><code class="text language-text" data-lang="text">/*
    向线程函数传递多个参数；
    多线程共享文件句柄
*/
typedef struct arg_struct
{
        int* heap;
        int* stack;
}ARG;
FILE* fp = NULL;
void* thfn(void* arg)
{
        ARG* p = (ARG*)arg;

        (*p-&gt;heap)++;
        (*p-&gt;stack)++;

        fprintf(fp, &quot;new thread heap : %d stack : %d\n&quot;,
                *(p-&gt;heap)), *(p-&gt;stack);
        printf(&quot;the new thread done\n&quot;);
        return NULL;
}

int main()
{
        pthread_t tid, tid2;
        ARG arg;
        int* heap;
        int stack;
        int err;

        heap = (int*)malloc(sizeof(int));
        if(NULL == heap){
                perror(&quot;fail to malloc&quot;);
                exit(1);
        }

        *heap = 2;
        stack = 3;

        arg.heap = heap;
        arg.stack = &amp;stack;

    /*此为wb，原因就是多进程共享文件句柄*/
        if((fp = fopen(&quot;test.txt&quot;, &quot;wb&quot;)) == NULL){
                perror(&quot;fail to open&quot;);
                exit(1);
        }

        err = pthread_create(&amp;tid, NULL, thfn, &amp;arg);
        if(0 != err){
                printf(&quot;can&#39;t create thread %s\n&quot;, strerror(err));
                exit(1);
        }

        sleep(10);
        (*heap)++;
        stack++;

        fprintf(fp, &quot;main thread: heap : %d stack : %d\n&quot;,
                                        *(arg.heap), *(arg.stack));
        printf(&quot;the main thread done\n&quot;);

        fclose(fp);
        free(heap);

        return 0;
}




cat test.txt
new thread heap : 3 stack : 4
main thread: heap : 4 stack : 5
</code></pre></div>
<h1></h1>

<p>从结果看以知道，文件中有线程输入的内容，所以新线程和进程(主线程)公用文件描述符、文件对象和数据段；</p>

<p>由于堆栈数据在函数thfn中自增会影响到主线程，所以新线程和进程公用堆和栈。</p>

<p>因此我们可以得出结论：</p>

<ul>
<li>进程中的地址空间对于任意一个线程来讲都是开放的！</li>
</ul>

<h1></h1>

<p>** 现在也可以解释为什么线程系列处理函数不设置errno变量，而是采用返回错误号的原因了。
**</p>

<p>** 由于线程可以随意访问进程的环境变量，所以当多个线程出错时候，errno变量的值将被多次覆盖，进程检查到的只是最后一个线程出错的原因 **</p>

<p>** 归根结底，还是由于线程出错和检查errno变量两个操作不是原子操作，因此线程系列处理函数只返回错误号，不会设置errno **</p>

<h1></h1>

      <hr />
      <footer role="contentinfo">
        <div class="article-author-bottom">
          <img src="http://ucshell.github.com/images/Neo.jpg" class="bio-photo" alt="Neo bio photo"></a>
<h3>Neo</h3>
<p>每一个优秀的人,都会有一段沉默的时光. 那一段时光,是付出了很多努力,忍受孤独和寂寞,不抱怨不诉苦. 日后说起时,连自己都能被感动的日子.</p>


<a href="https://plus.google.com/ucshell.neo@gmail.com" class="author-social" target="_blank"><i class="icon-google-plus"></i> Google+</a>










        </div>
        <p class="byline"><strong>线程(一):基础</strong> was published on <time datetime="2013-11-08T04:48:45Z">November 08, 2013</time> by <a href="http://ucshell.github.com/about" title="About Neo">Neo</a>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://ucshell.github.com/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://ucshell.github.com/2014/03/15/dynamic-link-libary/" title="静态连接与动态连接的区别">静态连接与动态连接的区别</a></li>
    
      <li><a href="http://ucshell.github.com/2014/03/15/compile-link/" title="程序编译的过程">程序编译的过程</a></li>
    
      <li><a href="http://ucshell.github.com/2014/03/14/memory-variable/" title="各种变量在程序内存中的分布">各种变量在程序内存中的分布</a></li>
    
    </ul>
    <hr />
        <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'ucshellcom'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  </div><!-- /.related-articles -->
  <footer>
    <br></br>
<br></br>
<span>&copy; 2013 - 2014 高手之路 ucshell.com , All Rights Reserved.   </span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://ucshell.github.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://ucshell.github.com/assets/js/scripts.min.js"></script>
	        

</body>
</html>