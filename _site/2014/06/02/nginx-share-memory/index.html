<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>nginx的slab机制 &#8211; 高手之路</title>
<meta name="description" content="">
<meta name="keywords" content="">


<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx的slab机制">
<meta property="og:description" content="专注于linux下程序设计">
<meta property="og:url" content="http://localhost:4000/2014/06/02/nginx-share-memory/">
<meta property="og:site_name" content="高手之路">





<link rel="canonical" href="http://localhost:4000/2014/06/02/nginx-share-memory/">
<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="高手之路 Feed">


<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Google Webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700|PT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>
<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.min.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://localhost:4000/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://localhost:4000/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://localhost:4000/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://localhost:4000/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://localhost:4000/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://localhost:4000/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://localhost:4000/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://localhost:4000/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://localhost:4000">高手之路</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				<li><a href="http://localhost:4000" >Home</a></li>
		        
				<li><a href="http://localhost:4000/category/" >Category</a></li>
		        
				<li><a href="http://localhost:4000/posts/" >Posts</a></li>
		        
				<li><a href="http://localhost:4000/about/" >About</a></li>
		        
				<li><a href="http://localhost:4000/comment/" >Leave a message</a></li>
		        
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    <img src="http://localhost:4000/images/Neo.jpg" class="bio-photo" alt="Neo bio photo"></a>
<h3>Neo</h3>
<p>每一个优秀的人,都会有一段沉默的时光. 那一段时光,是付出了很多努力,忍受孤独和寂寞,不抱怨不诉苦. 日后说起时,连自己都能被感动的日子.</p>














<ul>
    
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the linux" title="view all
posts">the linux <span style="margin-left:10px;">(44)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the other" title="view all
posts">the other <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the life" title="view all
posts">the life <span style="margin-left:10px;">(7)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the c\c++" title="view all
posts">the c\c++ <span style="margin-left:10px;">(25)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the win32asm" title="view all
posts">the win32asm <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the datebase" title="view all
posts">the datebase <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the tool" title="view all
posts">the tool <span style="margin-left:10px;">(21)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the algorithm" title="view all
posts">the algorithm <span style="margin-left:10px;">(14)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#操作系统" title="view all
posts">操作系统 <span style="margin-left:10px;">(1)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#剑指offer" title="view all
posts">剑指offer <span style="margin-left:10px;">(6)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#信号" title="view all
posts">信号 <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#网络编程" title="view all
posts">网络编程 <span style="margin-left:10px;">(13)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#编程珠玑" title="view all
posts">编程珠玑 <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#gdb" title="view all
posts">gdb <span style="margin-left:10px;">(12)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#nginx" title="view all
posts">nginx <span style="margin-left:10px;">(17)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#vim" title="view all
posts">vim <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#线程" title="view all
posts">线程 <span style="margin-left:10px;">(9)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#makefile" title="view all
posts">makefile <span style="margin-left:10px;">(5)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the reading" title="view all
posts">the reading <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#stl" title="view all
posts">stl <span style="margin-left:10px;">(11)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#树" title="view all
posts">树 <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#shell" title="view all
posts">shell <span style="margin-left:10px;">(15)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#sed" title="view all
posts">sed <span style="margin-left:10px;">(5)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#awk" title="view all
posts">awk <span style="margin-left:10px;">(5)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#进程" title="view all
posts">进程 <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#排序" title="view all
posts">排序 <span style="margin-left:10px;">(1)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the network" title="view all
posts">the network <span style="margin-left:10px;">(3)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#mysql" title="view all
posts">mysql <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#security" title="view all
posts">security <span style="margin-left:10px;">(1)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#kernel" title="view all
posts">kernel <span style="margin-left:10px;">(2)</span></a>
    </li>
    
</ul>


  </div>
  <article>
    <div class="headline-wrap">
      <h1>nginx的slab机制</h1>
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>Nginx的slab机制主要是两点:缓存与对齐;</p>

<p>缓存就是预先分配,提前申请号内存并对被踩做好划分形成内存池;</p>

<p>对齐就是内存的申请与分配总是按照2的幂次方进行,即内存的大小总是8,16,32,64等,例如虽然只申请33个字节内存,但是还是会分撇64字节大小的内存,虽然会浪费内存,但是对于性能有一个很高的提升,并且将内存碎片掌握在可控的范围之内.</p>

<p>nginx的slab机制主要是和共享内存一起使用,对于共享内存,nginx在解析配置文件时候,将即将使用的共享内存全部以list链表的形式组织在全局变量cf->cycle->shared_memory,然后进行统一的内存分配.slab机制就是对这些内存进行进一步的内部划分与管理</p>

<pre><code>917 static ngx_int_t
918 ngx_init_zone_pool(ngx_cycle_t *cycle, ngx_shm_zone_t *zn)
919 {
920     u_char           *file;
921     ngx_slab_pool_t  *sp;
922 
923     sp = (ngx_slab_pool_t *) zn-&gt;shm.addr;
924 
925     if (zn-&gt;shm.exists) {
926 
927         if (sp == sp-&gt;addr) {
928             return NGX_OK;
929         }
930 
931         ngx_log_error(NGX_LOG_EMERG, cycle-&gt;log, 0,
932                       "shared zone \"%V\" has no equal addresses: %p vs %p",
933                       &amp;zn-&gt;shm.name, sp-&gt;addr, sp);
934         return NGX_ERROR;
935     }
936 
937     sp-&gt;end = zn-&gt;shm.addr + zn-&gt;shm.size;
938     sp-&gt;min_shift = 3;
939     sp-&gt;addr = zn-&gt;shm.addr;
940 
941 #if (NGX_HAVE_ATOMIC_OPS)
942 
943     file = NULL;
944 
945 #else
946 
947     file = ngx_pnalloc(cycle-&gt;pool, cycle-&gt;lock_file.len + zn-&gt;shm.name.len);
948     if (file == NULL) {
949         return NGX_ERROR;
950     }
951 
952     (void) ngx_sprintf(file, "%V%V%Z", &amp;cycle-&gt;lock_file, &amp;zn-&gt;shm.name);
953 
954 #endif (ngx_shmtx_create(&amp;sp-&gt;mutex, &amp;sp-&gt;lock, file) != NGX_OK) {
957         return NGX_ERROR;
958     }
959 
        /*  调用slab初始化操作   */
960     ngx_slab_init(sp);
961 
962     return NGX_OK;
963 }
</code></pre>

<p>ngx_init_zone_pool是在共享内存分配好之后进行的初始化调用,在函数中又会调用slab的初始化函数ngx_slab_init</p>

<pre><code>25 typedef struct {
26     ngx_shmtx_sh_t    lock;
27 
28     size_t            min_size;          /*  固定值为8,最小划分块的大小,即1 &lt;&lt; pool-&gt;min_shift  */
29     size_t            min_shift;         /*  固定值为3   */
30     
31     ngx_slab_page_t  *pages;
32     ngx_slab_page_t   free;
33 
34     u_char           *start;
35     u_char           *end;
36 
37     ngx_shmtx_t       mutex;
38 
39     u_char           *log_ctx;
40     u_char            zero;
41 
42     void             *data;
43     void             *addr;
44 } ngx_slab_pool_t;
</code></pre>

<p>共享内存的初始化布局图:</p>

<p><img src="/uploads/2014/06/001.png" alt="001" /></p>

<p>根据图片可以看到共享内存的开始部分内存已经被用作结构体ngx_slab_pool_t的存储空间,这相当于是slab的额外开销,因为任何一种管理机制都需要有自己的一些控制信息需要存储,所以这些内存的使用无法避免. 剩下的内存才是被管理的主体.</p>

<p>slab机制对内存进行两级管理,首先是page页,然后是page页内的slab块(简称为slot块),也就是说slot块是在page页内存的再一次管理</p>

<pre><code>76 void
77 ngx_slab_init(ngx_slab_pool_t *pool)
78 {
79     u_char           *p;
80     size_t            size;
81     ngx_int_t         m;
82     ngx_uint_t        i, n, pages;
83     ngx_slab_page_t  *slots;
84 
85     /* STUB */

        /*  ngx_slab_max_size是slots分配和pages分配的分隔点,
        *   大于等于该值则要从pages里分配,其值为2048
        */
86     if (ngx_slab_max_size == 0) {        
87         ngx_slab_max_size = ngx_pagesize / 2;
            /*  
            *   ngx_slab_exact_size的值为128,刚好能用一个uintptr_t类型的位图变量表示该页的划分;
            *   例如在4k的内存页,32位环境下,一个uintptr_t类型的位图变量最多可以对应表达32个划分块的状态
            *   所以要恰好完整的表示一个4K内存页的每一个划分块状态, 
            *   必须将这个4K内存页划分成32个块,即每块的大小为128
            */
88         ngx_slab_exact_size = ngx_pagesize / (8 * sizeof(uintptr_t));
89         for (n = ngx_slab_exact_size; n &gt;&gt;= 1; ngx_slab_exact_shift++) {
90             /* void */
91         }
92     }
93     /**/
94 
95     pool-&gt;min_size = 1 &lt;&lt; pool-&gt;min_shift;
96 
97     p = (u_char *) pool + sizeof(ngx_slab_pool_t);
98     size = pool-&gt;end - p;
99 
100     ngx_slab_junk(p, size);
101 
102     slots = (ngx_slab_page_t *) p;
        /*  ngx_pagesize_shift值为12,对应ngx_pagesize(4096), 即4096=1&lt;&lt;12  */
103     n = ngx_pagesize_shift - pool-&gt;min_shift;
104 
105     for (i = 0; i &lt; n; i++) {
106         slots[i].slab = 0;
107         slots[i].next = &amp;slots[i];
108         slots[i].prev = 0;
109     }
110 
111     p += n * sizeof(ngx_slab_page_t);
112 
113     pages = (ngx_uint_t) (size / (ngx_pagesize + sizeof(ngx_slab_page_t)));
114 
115     ngx_memzero(p, pages * sizeof(ngx_slab_page_t));
116 
117     pool-&gt;pages = (ngx_slab_page_t *) p;
118 
119     pool-&gt;free.prev = 0;
120     pool-&gt;free.next = (ngx_slab_page_t *) p;
121 
122     pool-&gt;pages-&gt;slab = pages;
123     pool-&gt;pages-&gt;next = &amp;pool-&gt;free;
124     pool-&gt;pages-&gt;prev = (uintptr_t) &amp;pool-&gt;free;
125 
126     pool-&gt;start = (u_char *)
127                   ngx_align_ptr((uintptr_t) p + pages * sizeof(ngx_slab_page_t),
128                                  ngx_pagesize);
129 
        /*  
        *   在末尾如果不够一个page内存页,则会被浪费掉
        *   一下代码是对最终可用内存的调整
        */
130     m = pages - (pool-&gt;end - pool-&gt;start) / ngx_pagesize;
        /*  m &gt; 0则说明对齐操作导致实际可用的内存页减少*/
131     if (m &gt; 0) {
132         pages -= m;         /*  pages去掉多出的部分,则刚好组成实际最终可用的pages的个数   */
133         pool-&gt;pages-&gt;slab = pages;
134     }
135 
136     pool-&gt;log_ctx = &amp;pool-&gt;zero;
137     pool-&gt;zero = '\0';
138 }
</code></pre>

<p>slab机制对page页的管,初始结构如图:</p>

<p><img src="/uploads/2014/06/002.png" alt="002" /></p>

<h4>page的静态管理</h4>

<p>slab对page页的静态管理主要体现在ngx_slab_page_t[K]和page[K]这两个数组上;</p>

<pre><code>16 typedef struct ngx_slab_page_s  ngx_slab_page_t;
17 
18 struct ngx_slab_page_s {
19     uintptr_t         slab;
20     ngx_slab_page_t  *next;
21     uintptr_t         prev;
22 };
23 
</code></pre>

<h5>注意:</h5>

<p>1.对齐是指实际page内存页按照ngx_pagesize大小对齐,从图中可以看到,原本start是那个虚线箭头的位置,对齐后就是实现箭头所在的位置,对齐能提高对内存页的访问速度,但是有一些内存浪费,并且末尾可能因为不够一个page内存页而被浪费掉(因为对齐的缘故),所以在ngx_slab_init函数的最末尾有一次最终可用内存页的准确调整.</p>

<p>2.虽然一个页面管理结构(ngx_slab_page_t元素)与一个page内存页相对应,但因为有对齐消耗以及slot块管理结构体的占用(ngx_slab_page_t[n]数组),所以实际上页管理街头体数目比page页内存数目要多,即图中ngx_slab_page_t[N]到ngx_slab_pool_t[K-1]实际上没有对应的page页,所以这部分将会被忽视,虽然他们是存在的.</p>

<h4>page的动态管理</h4>

<p>动态管理即page页的申请和释放;</p>

<p>page页被申请或释放,那么就有了响应的状态,使用或空闲状态;</p>

<h5>page空闲状态的管理</h5>

<p>nginx对空闲page页进行链式管理,链表的头节点pool->free,初始状态下链表如图:</p>

<p><img src="/uploads/2014/06/003.png" alt="003" /></p>

<p>这是一个特别的链表,它的节点是一个数组,例如图中的ngx_slab_page_t数组就是一个链表节点,这个数组通过0号数组元素ngx_slab_page_t[0]接入到这个空闲page页链表内,整个数组的元素个数也记录在第0号元素的slab字段内</p>

<p>子进程1从共享内存中申请1页,状态如图:</p>

<p><img src="/uploads/2014/06/004.png" alt="004" /></p>

<p>子进程2从共享内存中申请2页,状态如图:</p>

<p><img src="/uploads/2014/06/005.png" alt="005" /></p>

<p>子进程有释放刚刚申请的1页</p>

<p><img src="/uploads/2014/06/006.png" alt="006" /></p>

<p><strong>释放page页被插入到链表头部</strong>,如果子进程2接着释放其拥有的那2页内存,如图:</p>

<p><img src="/uploads/2014/06/007.png" alt="007" /></p>

<p>可以看到nginx对空闲page页的链式管理不会进行节点合并,不过没有关系,因为page也既不是slab机制的最小管理单元,也不是其主要分配单元</p>

<h4>slab的第二级管理--slot块</h4>

<p>slot块是对每一个page内存的内部管理,它将page页划分成很多个小块,各个page页的slot块大小可以不相等,但是同一个page页内slot块大小一定相等,page页的状态通过其所在链表即可表明是否空闲,但是page页内的各个slot块的状态却需要一个额外的标记,nginx中具体实现采用的是位图,即每个bit位标记一个对应slot块的状态,1为使用,0未空闲.</p>

<p>根据slot块大小的不同,每个page页可划分的slot块数也不同,从而需要的位图的大小也不同,每一个page页对应一个名为ngx_slab_page_t的管理结构,该结构体有一个uintptr_t类型的slab字段,在32位平台上uintptr_t占4个字节,即slba字段有32个bit位,如果page页划分的slot块数小于等于32,那么nginx直接利用该字段充当位图,在nginx内叫做exact划分,每个slot块的大小保存在全局变量ngx_slab_exact_size以及ngx_slab_exact_shift内.例如一个4k的page页,如果每个slot块大小为128字节,那么恰好可以分成32块.如图:</p>

<p><img src="/uploads/2014/06/008.png" alt="008" /></p>

<p>如果划分的每个slot块比ngx_slab_exact_size还大,那么意味着一个page也划分的slot块数更少,所以此时依然可以使用ngx_slab_page_t结构体的slab字段作为位图,但是由于比ngx_slab_exact_size大的情况有很多种,因此需要将其具体大小记录下来,这个值同样记录在slab字段内.怎么记录呢?由于划分的时候是按照2的幂次方进行增长的,所以比ngx_slab_exact_size还大,那至少是ngx_slab_exact_size的2倍,那么此时划分的至少要减少slot块的一半,因此利用slab字段的一般bit位即可完成表示所有slot块的状态;</p>

<p>具体的就是:slab字段的高端bit做位图,低端bit用于存储slot块大小.</p>

<p>如果申请的内存大于等于ngx_slab_max_size,那么nginx直接返回一个page整页,此时已经不存在slot块管理了</p>

<p>如果申请小于ngx_slab_exact_size时候,此时slot块的数目已经超过了slab位图可以表示的容量,比如按照8字节划分,那么1个4K的page页将会被划分成512块,表示slot块状态的位图也就需要512个bit位,一个slab字段明显是不够的,所以需要为位图另找存储空间,而slab字段仅仅用于存储slot块大小(仅仅存储其对应的位移数).</p>

<p>另找的位图存储空间就落在page页内,具体就是其划分的前面几个slot块内,例如512个bit位的位图即64字节,而一个slot块内有8个字节,所以就需要占用page页的前8个slot块做位图,一个按8字节划分slot块的page页初始状态如图:</p>

<p><img src="/uploads/2014/06/009.png" alt="009" /></p>

<p>由于前几个slot块一开始就被用作位图空间,所以必须将其对应的bit位设置为1,表示其状态为使用.其划分大小在slab字段内!</p>

<p>不论哪种情况,都有了slot块的大小以及状态,这样分配与释放就简单了!</p>

<h4>page的链式管理</h4>

<p>首先根据每页划分的slot块大小将各个page页加入到不同的链表内,即按照8,16,32,64,128,256,512,1024,2048一共是9条链,在ngx_slab_init中有对应的初始化</p>

<p>假设申请一块9字节的内存,那么slab机制将一共分配page那么多页,将它按照8字节做slot划分,并接入到链表slot[0]中</p>

<p>继续申请8字节的内存不会分配新的page页,除非刚刚那页pageA被使用完了,一旦页A被使用完了,它会被拆除链表</p>

<p><img src="/uploads/2014/06/010.png" alt="010" /></p>

<p>如果继续申请8字节的内存,那么nginx的slab机制必须分配新的page页(简称页B),此时页B会被加入到链表内,此时链表中只有一个节点,但是如果此时页A释放了末个slot块,它又会被加入到链表内,最终形成了两个节点的链表</p>

<p><img src="/uploads/2014/06/011.png" alt="011" /></p>

      <hr />
      <footer role="contentinfo">
        <div class="article-author-bottom">
          <img src="http://localhost:4000/images/Neo.jpg" class="bio-photo" alt="Neo bio photo"></a>
<h3>Neo</h3>
<p>每一个优秀的人,都会有一段沉默的时光. 那一段时光,是付出了很多努力,忍受孤独和寂寞,不抱怨不诉苦. 日后说起时,连自己都能被感动的日子.</p>














<ul>
    
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the linux" title="view all
posts">the linux <span style="margin-left:10px;">(44)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the other" title="view all
posts">the other <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the life" title="view all
posts">the life <span style="margin-left:10px;">(7)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the c\c++" title="view all
posts">the c\c++ <span style="margin-left:10px;">(25)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the win32asm" title="view all
posts">the win32asm <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the datebase" title="view all
posts">the datebase <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the tool" title="view all
posts">the tool <span style="margin-left:10px;">(21)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the algorithm" title="view all
posts">the algorithm <span style="margin-left:10px;">(14)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#操作系统" title="view all
posts">操作系统 <span style="margin-left:10px;">(1)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#剑指offer" title="view all
posts">剑指offer <span style="margin-left:10px;">(6)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#信号" title="view all
posts">信号 <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#网络编程" title="view all
posts">网络编程 <span style="margin-left:10px;">(13)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#编程珠玑" title="view all
posts">编程珠玑 <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#gdb" title="view all
posts">gdb <span style="margin-left:10px;">(12)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#nginx" title="view all
posts">nginx <span style="margin-left:10px;">(17)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#vim" title="view all
posts">vim <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#线程" title="view all
posts">线程 <span style="margin-left:10px;">(9)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#makefile" title="view all
posts">makefile <span style="margin-left:10px;">(5)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the reading" title="view all
posts">the reading <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#stl" title="view all
posts">stl <span style="margin-left:10px;">(11)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#树" title="view all
posts">树 <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#shell" title="view all
posts">shell <span style="margin-left:10px;">(15)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#sed" title="view all
posts">sed <span style="margin-left:10px;">(5)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#awk" title="view all
posts">awk <span style="margin-left:10px;">(5)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#进程" title="view all
posts">进程 <span style="margin-left:10px;">(2)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#排序" title="view all
posts">排序 <span style="margin-left:10px;">(1)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#the network" title="view all
posts">the network <span style="margin-left:10px;">(3)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#mysql" title="view all
posts">mysql <span style="margin-left:10px;">(4)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#security" title="view all
posts">security <span style="margin-left:10px;">(1)</span></a>
    </li>
    
    <li style="line-height:20px;list-style:none;font-weight:bold;"><a href="http://localhost:4000/category/#kernel" title="view all
posts">kernel <span style="margin-left:10px;">(2)</span></a>
    </li>
    
</ul>


        </div>
        <p class="byline"><strong>nginx的slab机制</strong> was published on <time datetime="2014-06-02T00:00:00+00:00">June 02, 2014</time> by <a href="http://localhost:4000/about" title="About Neo">Neo</a>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://localhost:4000/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://localhost:4000/2014/06/06/shell-sed-error/" title="sed error:unterminated `s' command">sed error:unterminated `s' command</a></li>
    
      <li><a href="http://localhost:4000/2014/06/05/shell-debug/" title="shell脚本的调试">shell脚本的调试</a></li>
    
      <li><a href="http://localhost:4000/2014/06/05/kernel-memory-align/" title="内存对齐的实现">内存对齐的实现</a></li>
    
    </ul>
    <hr />
        <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'ucshellcom'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
  </div><!-- /.related-articles -->
  <footer>
    <br></br>
<br></br>
<span>&copy; 2013 - 2014 高手之路 ucshell.com , All Rights Reserved.   </span>

  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://localhost:4000/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://localhost:4000/assets/js/scripts.min.js"></script>
	        

</body>
</html>